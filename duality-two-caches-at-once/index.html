<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta content="[Duality](http://github.com/rubyops/duality) is a simple cache helper for using multiple caches. The idea is that you have local cache and a shared cache -- or fast and slow cache -- and want to save to both, and read from local, if present and shared if not. The idea came from [Hector Virgen](http://www.virgentech.com/) (the PHP Zend Jedi Ninja Badass) and [Zend\_Cache\_Backend\_TwoLevels](http://framework.zend.com/manual/en/zend.cache.backends.html#zend.cache.backends.twolevels), which does basically the same thing in PHP." name="description">
<meta content="ruby" name="keywords">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="" name="author">
<link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/spacelab/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="//cdn.mervine.net/bootstrap/master.css" media="screen" rel="stylesheet">
<!--[if lte IE 6]>
      <link href='http://universal-ie6-css.googlecode.com/files/ie6.1.1.css' media='screen, projection' rel='stylesheet'>
    <![endif]--><!--[if lt IE 9]>
      <script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script>
    <![endif]--><link href="/articles.xml" rel="alternate" type="application/atom+xml">
<link href="//cdn.mervine.net/bootstrap/favicon.ico" rel="shortcut icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon.png" rel="apple-touch-icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114">
<title>Duality: Two Caches at Once</title>
</head>
<body style="padding-top: 10px !important">
    <div class="container">
      <div class="navbar navbar-default navbar-top" style="margin-bottom: 0px !important">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Home</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
<li class="">
              <a href="http://mervine.net/categories">Category List</a>
            </li>
            <li class="">
              <a href="http://mervine.net/projects">My Projects</a>
            </li>
            <li class="">
              <a href="http://mervine.net/notes">Notes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/hacks">Hacks</a>
            </li>
            <li class="">
              <a href="http://mervine.net/quotes">Quotes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/archive">Archives</a>
            </li>
          </ul>
<ul class="nav navbar-nav navbar-right visible-xs">
<li>
              <a href="http://twitter.com/mervinej">Twitter</a>
            </li>
            <li>
              <a href="http://linkedin.com/in/mervinej">Linkedin</a>
            </li>
            <li>
              <a href="http://github.com/jmervine">Github</a>
            </li>
            <li>
              <a href="http://www.gittip.com/jmervine">Gittip</a>
            </li>
          </ul>
</div>
      </div>
      <div class="container">
        <div class="page-header" style="margin-top: 0px !important;">
          <img src="http://www.gravatar.com/avatar/ed808193b8c2c8516715816f90a005b2.jpg?s=75" style="padding:5px 15px 15px; float:left"><a href="http://mervine.net/">
            <h1>mervine.net</h1>
          </a><small>Lessons learned, code written, hacks, etc.</small>
        </div>
      </div>
      <div class="container">
        <div class="col-sm-12 col-md-9">
          <div class="page_content container">
  <div class="page_content">
    <h1>Duality: Two Caches at Once</h1>

<h3>Duality - v0.0.4</h3>

<p><a href="http://github.com/rubyops/duality">Duality</a> is a simple cache helper for using multiple caches. The idea is that you have local cache and a shared cache -- or fast and slow cache -- and want to save to both, and read from local, if present and shared if not. The idea came from <a href="http://www.virgentech.com/">Hector Virgen</a> (the PHP Zend Jedi Ninja Badass) and <a href="http://framework.zend.com/manual/en/zend.cache.backends.html#zend.cache.backends.twolevels">Zend_Cache_Backend_TwoLevels</a>, which does basically the same thing in PHP.</p>

<p>A few things to note:</p>

<ul>
<li>It currently implements the methods of my other two cache projects -- <a href="/tag/diskcached">Diskcached</a> and <a href="/tag/mongocached">Monogocached</a>, both which take their implementation from the popular <a href="https://rubygems.org/gems/memcached">Memcached</a>.</li>
<li>I'm working on a Rails implementation, which uses <a href="http://api.rubyonrails.org/classes/ActiveSupport/Cache/Store.html">ActiveSupport::Cache::Store</a> -- more to come on that later.</li>
<li>My origional intent was to make sets asynchronous, but benchmarking shows that to be less efficent due either to my lack of knowledge in threaded development, or -- based on what I'm reading -- ruby inefficenies in threading.</li>
</ul>
<h3>Installation</h3>

<pre class="twilight">gem install duality 
</pre>

<p>Or via bundler:</p>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> file: Gemfile</span>
source <span class="Constant"><span class="Constant">:</span>rubygems</span>
gem <span class="String"><span class="String">'</span>duality<span class="String">'</span></span>
</pre>

<h3>Basic Usage</h3>

<pre class="twilight"><span class="Keyword">require</span> <span class="String"><span class="String">'</span>diskcached<span class="String">'</span></span>
<span class="Keyword">require</span> <span class="String"><span class="String">'</span>mongocached<span class="String">'</span></span> <span class="Comment"><span class="Comment">#</span> or memcached if you prefer</span>
<span class="Keyword">require</span> <span class="String"><span class="String">'</span>duality<span class="String">'</span></span>

<span class="Variable"><span class="Variable">$</span>cache</span> <span class="Keyword">=</span> <span class="Support">Dulatiy</span>.<span class="Entity">new</span>(<span class="Support">Diskcached</span>.<span class="Entity">new</span>, <span class="Support">Mongocached</span>.<span class="Entity">new</span>( host: <span class="String"><span class="String">'</span>remotehost<span class="String">'</span></span> ))

<span class="Comment"><span class="Comment">#</span> cache something</span>
<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">set</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>, <span class="String"><span class="String">'</span>cache_content<span class="String">'</span></span>)

<span class="Comment"><span class="Comment">#</span> get cache</span>
puts <span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">get</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>) <span class="Comment"><span class="Comment">#</span> =&gt; cache_content</span>

<span class="Comment"><span class="Comment">#</span> delete something</span>
<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">delete</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>)

<span class="Comment"><span class="Comment">#</span> flush cache</span>
<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">flush</span>
</pre>

<h3>Unimplemented Cache Methods</h3>

<p>One thing Duality does for compatability is pass methods via #method_missing. This allows for you to access any method your cache might implement, even if Duality doesn't itself implement it.</p>

<p>It's important to note, though, that the this implementation does not take advantage of the get methods speed increase by returning the faster cache first, but will perform the action in a serialized fashion on one cache, then the other. Additionally, by default, it will return the value of whichever cache works, meaning that if one raises and exception, returns false or nil, but the other returns successfully, it will return the successful result. This is by design.</p>

<p>To force both caches to "be good or die", I've implemented <strong>strict calls</strong>, where by you can prepend "strict_" to any method call which you know Duality doesn't implement and force it to fail if both caches don't return a valid result.</p>

<p>Another thing that's worth mentioning is if either cache raise an exception, it will be caught. If both caches raise an exception, <em>nil</em> will be returned. Also, if both caches return <em>nil</em>, <em>nil</em> will be returned.</p>

<h5>Example</h5>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> when only one cache contains requested method</span>

<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">one_only_method</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>) 
<span class="Comment"><span class="Comment">#</span> =&gt; returns implementing caches return value</span>

<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">strict_one_only_method</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>) 
<span class="Comment"><span class="Comment">#</span> =&gt; raises no method exception</span>

<span class="Comment"><span class="Comment">#</span></span>
<span class="Comment"><span class="Comment">#</span> when both caches contains requested method</span>

<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">both_only_method</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>)
<span class="Comment"><span class="Comment">#</span> =&gt; returns best match</span>

<span class="Variable"><span class="Variable">$</span>cache</span>.<span class="Entity">strict_both_only_method</span>(<span class="String"><span class="String">'</span>cache_key<span class="String">'</span></span>)
<span class="Comment"><span class="Comment">#</span> =&gt; returns best match</span>
</pre>

<h3>More Info</h3>

<ul>
<li><a href="http://rubyops.github.com/duality/doc/Duality.html">Documentation</a></li>
<li><a href="http://rubyops.github.com/duality/coverage/">Coverage</a></li>
<li><a href="https://github.com/rubyops/duality/blob/master/BENCHMARK.md">Benchmarks</a></li>
</ul>
<footer><p class="meta">
        Published
        on
        <time datetime="2012-07-21T16:46:00+00:00" pubdate>21 July 2012</time>
        in
        <a href="http://mervine.net/ruby">Ruby</a>
      </p>
    </footer><hr class="article_seperator">
<br><div id="disqus_thread">
      <script async src="http://rubyops.disqus.com/embed.js" type="text/javascript"></script><noscript>
        <a href="http://rubyops.disqus.com/embed.js?url=ref">View comments.</a>
      </noscript>
    </div>
  </div>
</div>
        </div>
        <div class="col-md-3 visible-md visible-lg">
          <div class="sidebar-nav">
              <ul class="share-buttons">
<li>
                  <a href="https://www.facebook.com/sharer/sharer.php?u=http://mervine.net/duality-two-caches-at-once" target="_blank">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Facebook.png"></a>
                </li>
                <li>
                  <a href="https://twitter.com/intent/tweet?url=http://mervine.net/duality-two-caches-at-once&amp;text=Duality:%20Two%20Caches%20at%20Once%20-%20&amp;via=mervinej" target="_blank" title="Tweet">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Twitter.png"></a>
                </li>
                <li>
                  <a href="https://plus.google.com/share?url=http://mervine.net/duality-two-caches-at-once" target="_blank" title="Share on Google+">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Google.png"></a>
                </li>
                <li>
                  <a href="http://www.reddit.com/submit?url=http://mervine.net/duality-two-caches-at-once&amp;title=Duality:%20Two%20Caches%20at%20Once" target="_blank" title="Submit to Reddit">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Reddit.png"></a>
                </li>
                <li>
                  <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://mervine.net/duality-two-caches-at-once&amp;title=Duality:%20Two%20Caches%20at%20Once&amp;source=http://mervine.net/duality-two-caches-at-once" target="_blank" title="Share on LinkedIn">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/LinkedIn.png"></a>
                </li>
              </ul>
<div class="list-group">
<a class="list-group-item active" href="http://joshua.mervine.net/">
                  <h4 class="list-group-item-heading">Joshua P. Mervine</h4>
                </a><a class="list-group-item" href="http://twitter.com/mervinej">Twitter</a>
            <a class="list-group-item" href="http://linkedin.com/in/mervinej">Linkedin</a>
            <a class="list-group-item" href="http://github.com/jmervine">Github</a>
            <a class="list-group-item" href="http://www.gittip.com/jmervine">Gittip</a>
              </div>
            </div>
        </div>
      </div>
      <center>
        <br><div id="footer">
            <div class="container">
              <p class="muted credit">
                Powered by Nesta, a
                <a href="http://nestacms.com">Ruby CMS</a>.
              </p>
            </div>
          </div>
      </center>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script async src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js" type="text/javascript"></script><script>
      var searchElement = 'input[name=q]';
    </script><script async src="//cdn.jsdelivr.net/jquery.webpage-vim/0.1/vim.min.js" type="text/javascript"></script><script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-32343843-1']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
</body>
</html>
