<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta content="linux, notes" name="keywords">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="" name="author">
<link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/spacelab/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="//cdn.mervine.net/bootstrap/master.css" media="screen" rel="stylesheet">
<!--[if lte IE 6]>
      <link href='http://universal-ie6-css.googlecode.com/files/ie6.1.1.css' media='screen, projection' rel='stylesheet'>
    <![endif]--><!--[if lt IE 9]>
      <script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script>
    <![endif]--><link href="/articles.xml" rel="alternate" type="application/atom+xml">
<link href="//cdn.mervine.net/bootstrap/favicon.ico" rel="shortcut icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon.png" rel="apple-touch-icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114">
<title>Docker Tips</title>
</head>
<body style="padding-top: 10px !important">
    <div class="container">
      <div class="navbar navbar-default navbar-top" style="margin-bottom: 0px !important">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Home</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
<li class="">
              <a href="http://mervine.net/categories">Category List</a>
            </li>
            <li class="">
              <a href="http://mervine.net/projects">My Projects</a>
            </li>
            <li class="">
              <a href="http://mervine.net/notes">Notes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/hacks">Hacks</a>
            </li>
            <li class="">
              <a href="http://mervine.net/quotes">Quotes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/archive">Archives</a>
            </li>
          </ul>
<ul class="nav navbar-nav navbar-right visible-xs">
<li>
              <a href="http://twitter.com/mervinej">Twitter</a>
            </li>
            <li>
              <a href="http://linkedin.com/in/mervinej">Linkedin</a>
            </li>
            <li>
              <a href="http://github.com/jmervine">Github</a>
            </li>
            <li>
              <a href="http://www.gittip.com/jmervine">Gittip</a>
            </li>
          </ul>
</div>
      </div>
      <div class="container">
        <div class="page-header" style="margin-top: 0px !important;">
          <img src="http://www.gravatar.com/avatar/ed808193b8c2c8516715816f90a005b2.jpg?s=75" style="padding:5px 15px 15px; float:left"><a href="http://mervine.net/">
            <h1>mervine.net</h1>
          </a><small>Lessons learned, code written, hacks, etc.</small>
        </div>
      </div>
      <div class="container">
        <div class="col-sm-12 col-md-9">
          <div class="page_content container">
  <div class="page_content">
    <h1>Docker Tips</h1>

<p>Here are a few tips that I've found useful while delving in to <a href="https://www.docker.com/">Docker</a>. For an introduction to Docker, see my post on the <a href="http://engineering.yp.com/post/intro-to-docker">YP Engineering Blog</a>. Enjoy!</p>

<h3>Making smaller images.</h3>

<p>Docker image size does matter. The larger your image, that more unweildy it starts to feel. Pulling a 50MB image is far preferable to pulling a 2G image. Some tips on building smaller images:</p>

<ul>
<li>Use the smallest linux distro which meets your needs; <code>busybox</code> &lt; <code>debian</code> &lt; <code>centos</code> &lt; <code>ubuntu</code>. I try to use <code>progrium/busybox</code> whenever possible (which isn't all that often without serious work), otherwise, I tend to use <code>debian</code>.</li>
<li>Install as little as possible to meet your needs -- <code>apt-get build-essential</code> is going to bloat your image, don't use it unless absolutly necessary.</li>
<li>
<p>Do as much as you can in a single <code>RUN</code>, as opposed to breaking things up. The downside to this is longer builds with less caching. However, it can make a huge difference in resulting image size. I once took an image from 1.3G to 555MB, just by collapsing all my commands to a single <code>RUN</code>. Additionally, clean up after yourself in that same <code>RUN</code> if possible. Example:</p>

<pre class="twilight">  # BAD
  RUN apt-get install git
  RUN apt-get install wget
  RUN apt-get install build-essential
  COPY http://somesite.com/somefile.tgz
  RUN tar xzf somefile.tgz
  RUN cd somefile
  RUN ./configure &amp;&amp; make &amp;&amp; install

  # GOOD
  RUN \
      apt-get install -y git wget build-essential &amp;&amp; \
      curl -sSL -O http://somesite.com/somefile.tgz &amp;&amp; \
      tar xzf somefile.tgz &amp;&amp; \ 
      cd somefile &amp;&amp; ./configure &amp;&amp; make &amp;&amp; install &amp;&amp; \
      cd - &amp;&amp; rm -rf somefile somefile.tgz &amp;&amp; \
      apt-get remove -y build-essential &amp;&amp; \
      apt-get autoremove -y &amp;&amp; apt-get clean
</pre>
</li>
</ul>
<h3>Search private registry.</h3>

<pre class="twilight">sudo docker search <span class="Keyword">&lt;</span>private domain<span class="Keyword">&gt;</span>/<span class="Keyword">&lt;</span>term<span class="Keyword">&gt;</span>
</pre>

<h3>Removing images and containers in bulk.</h3>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> remove all containers</span>
sudo docker rm <span class="String"><span class="String">$(</span>sudo docker ps -a -q<span class="String">)</span></span>
<span class="Comment"><span class="Comment">#</span>... or ...</span>
sudo docker ps -aq <span class="Keyword">|</span> xargs sudo docker rm

<span class="Comment"><span class="Comment">#</span> remove all images</span>
sudo docker rmi <span class="String"><span class="String">$(</span>sudo docker images -q<span class="String">)</span></span>
<span class="Comment"><span class="Comment">#</span>... or ...</span>
sudo docker images -q <span class="Keyword">|</span> xargs sudo docker rmi

<span class="Comment"><span class="Comment">#</span> remove specific images in bulk</span>
sudo docker rmi myimage:{tagone,tagtwo,tagfive}

<span class="Comment"><span class="Comment">#</span> remove image containing TERM</span>
sudo docker rmi <span class="String"><span class="String">$(</span>sudo docker images <span class="Keyword">|</span> grep TERM <span class="Keyword">|</span> awk <span class="String"><span class="String">'</span>{ print $3 }<span class="String">'</span></span><span class="String">)</span></span>
<span class="Comment"><span class="Comment">#</span>... or ...</span>
sudo docker images <span class="Keyword">|</span> grep TERM <span class="Keyword">|</span> awk <span class="String"><span class="String">'</span>{ print $3 }<span class="String">'</span></span> <span class="Keyword">|</span> xargs sudo docker rmi

<span class="Comment"><span class="Comment">#</span> remove all non-running containers</span>
sudo docker ps -a <span class="Keyword">|</span> grep Exited <span class="Keyword">|</span> awk <span class="String"><span class="String">'</span>{ print $NF }<span class="String">'</span></span> <span class="Keyword">|</span> xargs sudo docker rm
</pre>

<h3>Interacting with the most recent continer started.</h3>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> view last container</span>
sudo docker ps -l 

<span class="Comment"><span class="Comment">#</span> view last container sha only</span>
sudo docker ps -lq

<span class="Comment"><span class="Comment">#</span> stop, start, attach, logs, etc. last container</span>
<span class="Comment"><span class="Comment">#</span></span>
<span class="Comment"><span class="Comment">#</span> $ sudo docker &lt;action&gt; $(sudo docker ps -lq)</span>
sudo docker start <span class="String"><span class="String">$(</span>sudo docker ps -lq<span class="String">)</span></span>
sudo docker stop <span class="String"><span class="String">$(</span>sudo docker ps -lq<span class="String">)</span></span>
sudo docker logs <span class="String"><span class="String">$(</span>sudo docker ps -lq<span class="String">)</span></span>
sudo docker attach <span class="String"><span class="String">$(</span>sudo docker ps -lq<span class="String">)</span></span>
</pre>

<h3>Pushing to a private registry.</h3>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> assuming image 'jmervine/centos6-nodejs'</span>
<span class="Comment"><span class="Comment">#</span></span>
<span class="Comment"><span class="Comment">#</span>               &lt;current image name&gt;    &lt;private registry&gt;:&lt;port&gt;/&lt;image name&gt;</span>
sudo docker tag jmervine/centos6-nodejs docker.myregstry.com:5000/jmervine/centos6-nodejs
sudo docker push docker.myregstry.com:5000/jmervine/centos6-nodejs

<span class="Comment"><span class="Comment">#</span> I then recommend removing your old image to avoid accidentally pushing it to the public registry.</span>
sudo docker rmi jmervine/centos6-nodejs
</pre>

<h3>Ports</h3>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> running randomly assigning host port</span>
sudo docker run -d -p 3000 image/name

<span class="Comment"><span class="Comment">#</span> running with exposed ports randomly assigned on host</span>
sudo docker run -d -P image/name

<span class="Comment"><span class="Comment">#</span> printing randomly assigned ports (only)</span>
sudo docker port image_name <span class="Keyword">|</span> awk -F<span class="String"><span class="String">'</span>:<span class="String">'</span></span> <span class="String"><span class="String">'</span>{ print $NF }<span class="String">'</span></span>
</pre>

<h3>Copying Files TO Containers</h3>

<pre class="twilight"><span class="Comment"><span class="Comment">#</span> Directly in to a running container.</span>
sudo docker exec -it <span class="Keyword">&lt;</span>container_name<span class="Keyword">|</span>name<span class="Keyword">&gt;</span> \
    bash -c <span class="String"><span class="String">"</span>echo <span class="StringConstant">\"</span><span class="String"><span class="String">$(</span>cat /path/to/host/file.txt<span class="String">)</span></span><span class="StringConstant">\"</span> &gt; /path/to/container/file.txt<span class="String">"</span></span>

<span class="Comment"><span class="Comment">#</span> When running a container.</span>
sudo docker run -i <span class="Keyword">&lt;</span>container_id<span class="Keyword">|</span>name<span class="Keyword">&gt;</span> \
    bash -c <span class="String"><span class="String">"</span>echo <span class="StringConstant">\"</span><span class="String"><span class="String">$(</span>cat /path/to/host/file.txt<span class="String">)</span></span><span class="StringConstant">\"</span> &gt; /path/to/container/file.txt; /bin/bash ./start.sh<span class="String">"</span></span>

<span class="Comment"><span class="Comment">#</span> Via Docker volume.</span>
<span class="Comment"><span class="Comment">#</span> - where 'file.txt' is /path/to/host/dir/file.txt</span>
sudo docker run -v /path/to/host/dir:/path/to/container/dir <span class="Keyword">&lt;</span>container_id<span class="Keyword">|</span>name<span class="Keyword">&gt;</span>

<span class="Comment"><span class="Comment">#</span>... or ...</span>
sudo docker run -v /path/to/host/dir:/path/to/container/dir <span class="Keyword">&lt;</span>container_id<span class="Keyword">|</span>name<span class="Keyword">&gt;</span>
cp /path/to/host/file.txt /path/to/host/dir/file.txt

<span class="Comment"><span class="Comment">#</span> Via file system -- untested as of yet.</span>
sudo cp -v /path/to/host/file.txt \
    /var/lib/docker/aufs/mnt/**<span class="String"><span class="String">$(</span>sudo docker inspect -f <span class="String"><span class="String">'</span>{{.Id}}<span class="String">'</span></span> <span class="Keyword">&lt;</span>container_id<span class="Keyword">|</span>name<span class="Keyword">&gt;</span><span class="String">)</span></span>**/root/path/to/container/file.txt
</pre>

<blockquote><p>Based on comments in <a href="http://stackoverflow.com/questions/22907231/copying-files-from-host-to-docker-container">http://stackoverflow.com/questions/22907231/copying-files-from-host-to-docker-container</a></p></blockquote>
    <footer><p class="meta">
        Published
        on
        <time datetime="2015-02-21T15:20:00+00:00" pubdate>21 February 2015</time>
        in
        <a href="http://mervine.net/linux">Linux</a>,
        <a href="http://mervine.net/notes">Notes</a>
      </p>
    </footer><hr class="article_seperator">
<br><div id="disqus_thread">
      <script async src="http://rubyops.disqus.com/embed.js" type="text/javascript"></script><noscript>
        <a href="http://rubyops.disqus.com/embed.js?url=ref">View comments.</a>
      </noscript>
    </div>
  </div>
</div>
        </div>
        <div class="col-md-3 visible-md visible-lg">
          <div class="sidebar-nav">
              <ul class="share-buttons">
<li>
                  <a href="https://www.facebook.com/sharer/sharer.php?u=http://mervine.net/notes/docker-tips" target="_blank">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Facebook.png"></a>
                </li>
                <li>
                  <a href="https://twitter.com/intent/tweet?url=http://mervine.net/notes/docker-tips&amp;text=Docker%20Tips%20-%20&amp;via=mervinej" target="_blank" title="Tweet">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Twitter.png"></a>
                </li>
                <li>
                  <a href="https://plus.google.com/share?url=http://mervine.net/notes/docker-tips" target="_blank" title="Share on Google+">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Google.png"></a>
                </li>
                <li>
                  <a href="http://www.reddit.com/submit?url=http://mervine.net/notes/docker-tips&amp;title=Docker%20Tips" target="_blank" title="Submit to Reddit">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Reddit.png"></a>
                </li>
                <li>
                  <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://mervine.net/notes/docker-tips&amp;title=Docker%20Tips&amp;source=http://mervine.net/notes/docker-tips" target="_blank" title="Share on LinkedIn">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/LinkedIn.png"></a>
                </li>
              </ul>
<div class="list-group">
<a class="list-group-item active" href="http://joshua.mervine.net/">
                  <h4 class="list-group-item-heading">Joshua P. Mervine</h4>
                </a><a class="list-group-item" href="http://twitter.com/mervinej">Twitter</a>
            <a class="list-group-item" href="http://linkedin.com/in/mervinej">Linkedin</a>
            <a class="list-group-item" href="http://github.com/jmervine">Github</a>
            <a class="list-group-item" href="http://www.gittip.com/jmervine">Gittip</a>
              </div>
            </div>
        </div>
      </div>
      <center>
        <br><div id="footer">
            <div class="container">
              <p class="muted credit">
                Powered by Nesta, a
                <a href="http://nestacms.com">Ruby CMS</a>.
              </p>
            </div>
          </div>
      </center>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script async src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js" type="text/javascript"></script><script>
      var searchElement = 'input[name=q]';
    </script><script async src="//cdn.jsdelivr.net/jquery.webpage-vim/0.1/vim.min.js" type="text/javascript"></script><script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-32343843-1']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
</body>
</html>
