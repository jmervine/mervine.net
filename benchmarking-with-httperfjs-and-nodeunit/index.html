<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta content="I covered this in the [HTTPerf.js README](/projects/npms/httperfjs) a bit, but wanted to take a deer look at how I'm using [HTTPerf.js](/projects/npms/httperfjs) to benchmark web applications." name="description">
<meta content="httperf, httperfjs, projects, nodejshttperfjs release" name="keywords">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="" name="author">
<link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/spacelab/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="//cdn.mervine.net/bootstrap/master.css" media="screen" rel="stylesheet">
<!--[if lte IE 6]>
      <link href='http://universal-ie6-css.googlecode.com/files/ie6.1.1.css' media='screen, projection' rel='stylesheet'>
    <![endif]--><!--[if lt IE 9]>
      <script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script>
    <![endif]--><link href="/articles.xml" rel="alternate" type="application/atom+xml">
<link href="//cdn.mervine.net/bootstrap/favicon.ico" rel="shortcut icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon.png" rel="apple-touch-icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114">
<title>Benchmarking with HTTPerf.js and NodeUnit - mervine.net</title>
</head>
<body style="padding-top: 10px !important">
    <div class="container">
      <div class="navbar navbar-default navbar-top" style="margin-bottom: 0px !important">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Home</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
<li class="">
              <a href="http://mervine.net/categories">Category List</a>
            </li>
            <li class="">
              <a href="http://mervine.net/projects">My Projects</a>
            </li>
            <li class="">
              <a href="http://mervine.net/notes">Notes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/hacks">Hacks</a>
            </li>
            <li class="">
              <a href="http://mervine.net/quotes">Quotes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/archive">Archives</a>
            </li>
          </ul>
<ul class="nav navbar-nav navbar-right visible-xs">
<li>
              <a href="http://twitter.com/mervinej">Twitter</a>
            </li>
            <li>
              <a href="http://linkedin.com/in/mervinej">Linkedin</a>
            </li>
            <li>
              <a href="http://github.com/jmervine">Github</a>
            </li>
            <li>
              <a href="http://www.gittip.com/jmervine">Gittip</a>
            </li>
          </ul>
</div>
      </div>
      <div class="container">
        <div class="page-header" style="margin-top: 0px !important;">
          <img src="http://www.gravatar.com/avatar/ed808193b8c2c8516715816f90a005b2.jpg?s=75" style="padding:5px 15px 15px; float:left"><a href="http://mervine.net/">
            <h1>mervine.net</h1>
          </a><small>Lessons learned, code written, hacks, etc.</small>
        </div>
      </div>
      <div class="container">
        <div class="col-sm-12 col-md-9">
          <div class="page_content container">
  <div class="page_content">
    <h1>Benchmarking with HTTPerf.js and NodeUnit</h1>

<p>I covered this in the <a href="/projects/npms/httperfjs">HTTPerf.js README</a> a bit, but wanted to take a deeper look at how I use <a href="/projects/npms/httperfjs">HTTPerf.js</a> and <a href="https://github.com/caolan/nodeunit">NodeUnit</a> to benchmark web applications.</p>

<blockquote>
<p>Note on benchmarking.</p>

<p>I've gone back and forth on using median and 85th percentile when benchmarking. I look at 85th percentile when running load tests and performance tests â€” basically when I'm trying to break my site. However, for simple benchmarks like this, median gives you a better perspective.</p>
</blockquote>

<h3>Setup</h3>

<p>Before getting started you'll need to install <code>node</code>, <code>httperf</code>, HTTPerf.js and NodeUnit.</p>

<pre class="twilight"># httperf
sudo apt-get install httperf # also available via brew and yum
sudo apt-get nodejs          # also available via brew and yum
npm install nodeunit httperf
</pre>

<h3>Benchmark Example One</h3>

<p>In my README, I have this basic example. It's pretty simple for small sites, where you want to benchmark just a few endpoints.</p>

<p><code>file: benchmark.js</code></p>

<pre class="twilight"><span class="Storage">var</span> HTTPerf <span class="Keyword">=</span> require(<span class="String"><span class="String">'</span>httperfjs<span class="String">'</span></span>);
<span class="Storage">var</span> httperf <span class="Keyword">=</span> <span class="Keyword">new</span> <span class="Entity">HTTPerf</span>({
    server:      <span class="String"><span class="String">"</span>mervine.net<span class="String">"</span></span>,
    uri:         <span class="String"><span class="String">"</span>/<span class="String">"</span></span>,
    <span class="String"><span class="String">"</span>num-conns<span class="String">"</span></span>: <span class="Constant">9</span>
});

<span class="Storage">var</span> run;

module.exports <span class="Keyword">=</span> {
    <span class="Entity">tearDown</span>: <span class="Storage">function</span> (<span class="Variable">callback</span>) {
        run <span class="Keyword">=</span> undefined;
        callback();
    },

    <span class="String"><span class="String">'</span><span class="Entity">homepage should be quick</span><span class="String">'</span></span>: <span class="Entity">function</span> (<span class="Variable">test</span>) {
        test.expect(<span class="Constant">1</span>);
        httperf.run( <span class="Storage">function</span> (<span class="Variable">run</span>) {
            test.ok(run.connection_time_avg <span class="Keyword">&lt;</span> <span class="Constant">200</span>,
                <span class="String"><span class="String">"</span>homepage was too slow: got <span class="String">"</span></span> <span class="Keyword">+</span> run.connection_time_avg
                   <span class="Keyword">+</span> <span class="String"><span class="String">"</span> but expected: &lt; 200<span class="String">"</span></span>);
            test.done();
        });
    },

    <span class="String"><span class="String">'</span><span class="Entity">archive should be quick</span><span class="String">'</span></span>: <span class="Entity">function</span> (<span class="Variable">test</span>) {
        test.expect(<span class="Constant">1</span>);
        httperf.run( <span class="Storage">function</span> (<span class="Variable">run</span>) {
            test.ok(run.connection_time_median <span class="Keyword">&lt;</span> <span class="Constant">200</span>,
                <span class="String"><span class="String">"</span>archive was too slow: got <span class="String">"</span></span> <span class="Keyword">+</span> run.connection_time_avg
                    <span class="Keyword">+</span> <span class="String"><span class="String">"</span> but expected: &lt; 200<span class="String">"</span></span>);
            test.done();
        });
    }
};
</pre>

<p>Run with:</p>

<pre class="twilight">$ ./node_modules/.bin/nodeunit ./benchmark.js
</pre>

<h3>Benchmark Example Two</h3>

<p>Now, let's pretend we have a real site, with a lot of endpoints that we potentially want to benchmark the performance of. The above will work, but as your list grows it will gradually become harder to maintain. In this example, I build my list of urls using an external <code>json</code> file and use a factory function within my test to generate the complete test cases.</p>

<p><code>file: tests.json</code></p>

<pre class="twilight">[
    { <span class="String"><span class="String">"</span>uri<span class="String">"</span></span>: <span class="String"><span class="String">"</span>/<span class="String">"</span></span>                 , <span class="String"><span class="String">"</span>expected<span class="String">"</span></span>: <span class="Constant">250</span> },
    { <span class="String"><span class="String">"</span>uri<span class="String">"</span></span>: <span class="String"><span class="String">"</span>/about<span class="String">"</span></span>            , <span class="String"><span class="String">"</span>expected<span class="String">"</span></span>: <span class="Constant">200</span> },
    { <span class="String"><span class="String">"</span>uri<span class="String">"</span></span>: <span class="String"><span class="String">"</span>/projects<span class="String">"</span></span>         , <span class="String"><span class="String">"</span>expected<span class="String">"</span></span>: <span class="Constant">200</span> },
    { <span class="String"><span class="String">"</span>uri<span class="String">"</span></span>: <span class="String"><span class="String">"</span>/archive<span class="String">"</span></span>          , <span class="String"><span class="String">"</span>expected<span class="String">"</span></span>: <span class="Constant">200</span> },
    { <span class="String"><span class="String">"</span>uri<span class="String">"</span></span>: <span class="String"><span class="String">"</span>/archive/2012<span class="String">"</span></span>     , <span class="String"><span class="String">"</span>expected<span class="String">"</span></span>: <span class="Constant">200</span> },
    { <span class="String"><span class="String">"</span>uri<span class="String">"</span></span>: <span class="String"><span class="String">"</span>/search?q=httperf<span class="String">"</span></span> , <span class="String"><span class="String">"</span>expected<span class="String">"</span></span>: <span class="Constant">1000</span> }
]
</pre>

<p><code>file: benchmark.js</code></p>

<pre class="twilight"><span class="Storage">var</span> testCases <span class="Keyword">=</span> require(<span class="String"><span class="String">'</span>./tests.json<span class="String">'</span></span>);
<span class="Storage">var</span> HTTPerf <span class="Keyword">=</span> require(<span class="String"><span class="String">'</span>httperfjs<span class="String">'</span></span>);
<span class="Storage">var</span> httperf <span class="Keyword">=</span> <span class="Keyword">new</span> <span class="Entity">HTTPerf</span>({
    server:      <span class="String"><span class="String">"</span>mervine.net<span class="String">"</span></span>,
    uri:         <span class="String"><span class="String">"</span>/<span class="String">"</span></span>,
    <span class="String"><span class="String">"</span>num-conns<span class="String">"</span></span>: <span class="Constant">9</span>
});
<span class="Storage">var</span> run;
<span class="Storage">function</span> <span class="Entity">testFactory</span>(<span class="Variable">uri, expected</span>) {
    tests[<span class="String"><span class="String">'</span>"<span class="String">'</span></span> <span class="Keyword">+</span> uri <span class="Keyword">+</span> <span class="String"><span class="String">'</span>" should be less then <span class="String">'</span></span> <span class="Keyword">+</span> expected] <span class="Keyword">=</span> <span class="Storage">function</span> (<span class="Variable">test</span>) {
        test.expect(<span class="Constant">1</span>);
        httperf.update_option(<span class="String"><span class="String">"</span>uri<span class="String">"</span></span>, uri);
        httperf.run( <span class="Storage">function</span> (<span class="Variable">run</span>) {
            test.ok(run.connection_time_median <span class="Keyword">&lt;</span> expected,
                <span class="String"><span class="String">"</span>too slow: got <span class="String">"</span></span> <span class="Keyword">+</span> run.connection_time_median
                    <span class="Keyword">+</span> <span class="String"><span class="String">"</span> but expected: &lt; <span class="String">"</span></span> <span class="Keyword">+</span> expected);
            test.done();
        });
    };
}
<span class="Storage">var</span> tests <span class="Keyword">=</span> {
    <span class="Entity">tearDown</span>: <span class="Storage">function</span> (<span class="Variable">callback</span>) {
        run <span class="Keyword">=</span> undefined;
        callback();
    },
};
testCases.forEach( <span class="Storage">function</span> (<span class="Variable">testCase</span>) {
    testFactory(testCase.uri, testCase.expected);
});
module.exports <span class="Keyword">=</span> tests;
</pre>

<p>Run with:</p>

<pre class="twilight">$ ./node_modules/.bin/nodeunit ./benchmark.js
</pre>

<p>This should generate some simple and pretty output like so:</p>

<pre class="twilight">benchmark.js
+ "/" should be less then 250
+ "/about" should be less then 200
+ "/projects" should be less then 200
+ "/archive" should be less then 200
+ "/archive/2012" should be less then 200
+ "/search?q=httperf" should be less then 1000

OK: 6 assertions (13445ms)
</pre>

<p>Enjoy!</p>
    <hr class="article_seperator">
<header><h2>Articles on Benchmarking with HTTPerf.js and NodeUnit</h2>
    </header><div class="well" style="padding-top: 0px; padding-bottom: 0px">
  <header><h2>
      <a href="http://mervine.net/projects/npms/httperfjs-release">HTTPerf.js: Release 0.1.0</a>
    </h2>
  </header><p>Removing <code>runSync</code>. Refactoring <code>run</code> to support sending spawned process <code>SIGINT</code> to capture current report from httperf and exit.</p>
  <p class="read_more">
    <a href="http://mervine.net/projects/npms/httperfjs-release">Continue reading</a>
  </p>
  <footer><p class="meta">
      Published
      on
      <time datetime="2014-02-27T16:30:00+00:00" pubdate>27 February 2014</time>
      in
      <a href="http://mervine.net/benchmarking-with-httperfjs-and-nodeunit">Benchmarking with HTTPerf.js and NodeUnit</a>,
      <a href="http://mervine.net/projects/npms/httperfjs">HTTPerf.js</a>,
      <a href="http://mervine.net/projects/npms">My NPMs</a>,
      <a href="http://mervine.net/projects">My Projects</a>,
      <a href="http://mervine.net/nodejs">Node.js</a>
    </p>
  </footer>
</div>
    <footer><p class="meta">
        Published
        on
        <time datetime="2013-07-17T06:30:00+00:00" pubdate>17 July 2013</time>
        in
        <a href="http://mervine.net/httperf">Httperf</a>,
        <a href="http://mervine.net/projects/npms/httperfjs">HTTPerf.js</a>,
        <a href="http://mervine.net/projects">My Projects</a>,
        <a href="http://mervine.net/nodejs">Node.js</a>
      </p>
    </footer><hr class="article_seperator">
<br><div id="disqus_thread">
      <script async src="http://rubyops.disqus.com/embed.js" type="text/javascript"></script><noscript>
        <a href="http://rubyops.disqus.com/embed.js?url=ref">View comments.</a>
      </noscript>
    </div>
  </div>
</div>
        </div>
        <div class="col-md-3 visible-md visible-lg">
          <div class="sidebar-nav">
              <ul class="share-buttons">
<li>
                  <a href="https://www.facebook.com/sharer/sharer.php?u=http://mervine.net/benchmarking-with-httperfjs-and-nodeunit" target="_blank">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Facebook.png"></a>
                </li>
                <li>
                  <a href="https://twitter.com/intent/tweet?url=http://mervine.net/benchmarking-with-httperfjs-and-nodeunit&amp;text=Benchmarking%20with%20HTTPerf.js%20and%20NodeUnit%20-%20mervine.net%20-%20&amp;via=mervinej" target="_blank" title="Tweet">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Twitter.png"></a>
                </li>
                <li>
                  <a href="https://plus.google.com/share?url=http://mervine.net/benchmarking-with-httperfjs-and-nodeunit" target="_blank" title="Share on Google+">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Google.png"></a>
                </li>
                <li>
                  <a href="http://www.reddit.com/submit?url=http://mervine.net/benchmarking-with-httperfjs-and-nodeunit&amp;title=Benchmarking%20with%20HTTPerf.js%20and%20NodeUnit%20-%20mervine.net" target="_blank" title="Submit to Reddit">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Reddit.png"></a>
                </li>
                <li>
                  <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://mervine.net/benchmarking-with-httperfjs-and-nodeunit&amp;title=Benchmarking%20with%20HTTPerf.js%20and%20NodeUnit%20-%20mervine.net&amp;source=http://mervine.net/benchmarking-with-httperfjs-and-nodeunit" target="_blank" title="Share on LinkedIn">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/LinkedIn.png"></a>
                </li>
              </ul>
<div class="list-group">
<a class="list-group-item active" href="http://joshua.mervine.net/">
                  <h4 class="list-group-item-heading">Joshua P. Mervine</h4>
                </a><a class="list-group-item" href="http://twitter.com/mervinej">Twitter</a>
            <a class="list-group-item" href="http://linkedin.com/in/mervinej">Linkedin</a>
            <a class="list-group-item" href="http://github.com/jmervine">Github</a>
            <a class="list-group-item" href="http://www.gittip.com/jmervine">Gittip</a>
              </div>
            </div>
        </div>
      </div>
      <center>
        <br><div id="footer">
            <div class="container">
              <p class="muted credit">
                Powered by Nesta, a
                <a href="http://nestacms.com">Ruby CMS</a>.
              </p>
            </div>
          </div>
      </center>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script async src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js" type="text/javascript"></script><script>
      var searchElement = 'input[name=q]';
    </script><script async src="//cdn.jsdelivr.net/jquery.webpage-vim/0.1/vim.min.js" type="text/javascript"></script><script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-32343843-1']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
</body>
</html>
