<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta content="Simple ruby disk cache for things like Sinatra which is implemented much like Memcached in hopes that in some cases they're interchangeable." name="description">
<meta content="caching, duality, gems, ruby" name="keywords">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="" name="author">
<link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/spacelab/bootstrap.min.css" media="screen" rel="stylesheet">
<link href="//cdn.mervine.net/bootstrap/master.css" media="screen" rel="stylesheet">
<!--[if lte IE 6]>
      <link href='http://universal-ie6-css.googlecode.com/files/ie6.1.1.css' media='screen, projection' rel='stylesheet'>
    <![endif]--><!--[if lt IE 9]>
      <script src='//html5shim.googlecode.com/svn/trunk/html5.js'></script>
    <![endif]--><link href="/articles.xml" rel="alternate" type="application/atom+xml">
<link href="//cdn.mervine.net/bootstrap/favicon.ico" rel="shortcut icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon.png" rel="apple-touch-icon">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-72x72.png" rel="apple-touch-icon" sizes="72x72">
<link href="//cdn.mervine.net/bootstrap/images/apple-touch-icon-114x114.png" rel="apple-touch-icon" sizes="114x114">
<title>Diskchached</title>
</head>
<body style="padding-top: 10px !important">
    <div class="container">
      <div class="navbar navbar-default navbar-top" style="margin-bottom: 0px !important">
        <div class="navbar-header">
          <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse" type="button">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Home</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
<li class="">
              <a href="http://mervine.net/categories">Category List</a>
            </li>
            <li class="">
              <a href="http://mervine.net/projects">My Projects</a>
            </li>
            <li class="">
              <a href="http://mervine.net/notes">Notes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/hacks">Hacks</a>
            </li>
            <li class="">
              <a href="http://mervine.net/quotes">Quotes</a>
            </li>
            <li class="">
              <a href="http://mervine.net/archive">Archives</a>
            </li>
            <li>
              <a href="https://github.com/jmervine/diskcached">Fork me on Github</a>
            </li>
          </ul>
<ul class="nav navbar-nav navbar-right visible-xs">
<li>
              <a href="http://twitter.com/mervinej">Twitter</a>
            </li>
            <li>
              <a href="http://linkedin.com/in/mervinej">Linkedin</a>
            </li>
            <li>
              <a href="http://github.com/jmervine">Github</a>
            </li>
            <li>
              <a href="http://www.gittip.com/jmervine">Gittip</a>
            </li>
          </ul>
</div>
      </div>
      <div class="container">
        <div class="page-header" style="margin-top: 0px !important;">
          <img src="http://www.gravatar.com/avatar/ed808193b8c2c8516715816f90a005b2.jpg?s=75" style="padding:5px 15px 15px; float:left"><a href="http://mervine.net/">
            <h1>mervine.net</h1>
          </a><small>Lessons learned, code written, hacks, etc.</small>
        </div>
      </div>
      <div class="container">
        <div class="col-sm-12 col-md-9">
          <div class="page_content container">
  <div class="page_content">
    <h1>Diskcached</h1>

<blockquote><p>Simple disk cache for things like Sinatra which is implemented much like Memcached in hopes that in some cases they're interchangeable.</p></blockquote>

<h3>
<a href="http://rubyops.github.com/diskcached/doc/Diskcached.html">Documentation</a> | <a href="http://rubyops.github.com/diskcached/coverage/index.html#_AllFiles">Coverage</a> | <a href="https://github.com/rubyops/diskcached/wiki/Benchmark-Output">Benchmarks</a>
</h3>

<h2>Introduction</h2>

<p>I created Diskcached as a simple cacheing layer for things like html fragments and database calls. I thought about using <a href="http://memcached.org/">memcached</a>, but as the app I was working on was running on a single server, it seemed overkill. Additionally, I looked at using <a href="http://rtomayko.github.com/rack-cache/">rack-cache</a>, but I felt it was a bit more complex then I was looking for. So Diskcached was born (although it was origiionally released as "simple_disk_cache" -- for about 12 hours).</p>

<ul>
<li>
<p>To the comment: "I'm not clear how memcached on a single server is overkill."</p>

<blockquote><ol>
<li>In some cases -- e.g. Dreamhost shared hosting and Heroku (I believe) -- it is difficult, if not impossible to install memcached. This is for those situations.</li>
<li>In all cases, disk space is cheaper than memory. For example, when I used <a href="http://myhosting.com">myhosting.com</a>, which charges $1 per 20G of disk storage and $1 per 512MB of memory. So in my case, I use Diskcached instead of memcached and my memory foot print is ~300MB. While at the moment, I could very easily handle running memcached without running out of memory, using disk based cacheing allows me to scale much further before having to upgrade my hosting package. Additionally, if you <a href="https://github.com/jmervine/ditty/wiki/Performance">check out my blogs performance metrics</a>, you'll see that Diskcached brought me from ~140ms render times, to ~1ms render times, allowing me to scale even further.</li>
</ol></blockquote>
</li>
<li>
<p>To the comment: "If you need memcache...then use it."</p>

<blockquote><ul>
<li>I totally agree!</li>
</ul></blockquote>
</li>
</ul>
<h2>Installation</h2>

<pre class="twilight">gem install diskcached
</pre>

<p>Or with <a href="http://mervine.net/tag/bundler">Bundler</a>:</p>

<pre class="twilight">source <span class="Constant"><span class="Constant">:</span>rubygems</span>
gem <span class="String"><span class="String">'</span>diskcached<span class="String">'</span></span>
</pre>

<h2>Basic Usage</h2>

<h3>Block Style</h3>

<pre class="twilight"><span class="Keyword">require</span> <span class="String"><span class="String">'</span>diskcached<span class="String">'</span></span>
<span class="Variable"><span class="Variable">@</span>diskcache</span> <span class="Keyword">=</span> <span class="Support">Diskcached</span>.<span class="Entity">new</span>

result <span class="Keyword">=</span> <span class="Variable"><span class="Variable">@</span>diskcache</span>.<span class="Entity">cache</span>(<span class="String"><span class="String">'</span>expensive_code<span class="String">'</span></span>) <span class="Keyword">do</span>
<span class="Comment">  <span class="Comment">#</span> some expensive code</span>
<span class="Keyword">end</span>

puts result
</pre>

<p>The above will create the cache if it doesn't exist and cache the result of block and return it. If the cache exists and isn't expired, it will read from the cache and returnwhat's stored. This allows you to passively wrap code in a cache block and not worry about checking to see if it's valid or expired.</p>

<p>Also worth noting, it will return <code>nil</code> if something goes wrong.</p>

<h3>Memcached Style</h3>

<p>Using Diskcached like this should allow for a "drag and drop" replacement of Memcached, should you so decide.</p>

<pre class="twilight"><span class="Keyword">require</span> <span class="String"><span class="String">'</span>diskcached<span class="String">'</span></span>
<span class="Variable"><span class="Variable">@</span>diskcache</span> <span class="Keyword">=</span> <span class="Support">Diskcached</span>.<span class="Entity">new</span>

<span class="Keyword">begin</span>
  result <span class="Keyword">=</span> <span class="Variable"><span class="Variable">@</span>diskcache</span>.<span class="Entity">get</span>(<span class="String"><span class="String">'</span>expensive_code<span class="String">'</span></span>)
<span class="Keyword">rescue</span> <span class="Comment"><span class="Comment">#</span> Diskcached::NotFound # prevents easy replacement, but is safer.</span>
  result <span class="Keyword">=</span> run_expensive_code
  <span class="Variable"><span class="Variable">@</span>diskcache</span>.<span class="Entity">set</span>(<span class="String"><span class="String">'</span>expensive_code<span class="String">'</span></span>, result)
<span class="Keyword">end</span>

puts result
</pre>

<p>It's important to note that Diskcached is quite a bit simpler then Memcached and in some ways more forgiving. If Memcached compatability is really important, refer to Memcached docs as well as Diskcached docs when implementing your code.</p>

<h2>Benchmarks</h2>

<h3>Comments</h3>

<p>Diskcached wasn't designed to be a faster solution, just a simpler
one when compaired to Memcached. However, from these benchmarks,
it holds up will and even should provide slightly faster reads.</p>

<h5><a href="https://github.com/rubyops/diskcached/wiki/Benchmark-Output">Moved to 'Benchmark Output'</a></h5>

<h2>Sinatra Application 'httperf' results.</h2>

<p>On a development machine (Unicorn w/ 1 worker) I ran a series of <a href="http://www.hpl.hp.com/research/linux/httperf/">httperf</a> tests to see how Diskcached ran in real world situations. You can <a href="https://gist.github.com/3062334">checkout the full output from multiple examples here</a>, but there's a taste...</p>

<p>Using the endpoint <a href="http://mervine.net/">http://mervine.net/</a> on my dev server and hitting it 100,000 times --</p>

<h3>Code Example from Test</h3>

<pre class="twilight"> <span class="Constant">15</span>   configure <span class="Keyword">do</span>
        ...
 <span class="Constant">44</span>     <span class="Variable"><span class="Variable">$</span>diskcache</span> <span class="Keyword">=</span> <span class="Support">Diskcached</span>.<span class="Entity">new</span>(<span class="Support">File</span>.<span class="Entity">join</span>(settings.<span class="Entity">root</span>, <span class="String"><span class="String">'</span>cache<span class="String">'</span></span>))
 <span class="Constant">45</span>     <span class="Variable"><span class="Variable">$</span>diskcache</span>.<span class="Entity">flush</span> <span class="Comment"><span class="Comment">#</span> ensure caches are empty on startup</span>
 <span class="Constant">46</span>   <span class="Keyword">end</span>
      ...
 <span class="Constant">58</span>   before <span class="Keyword">do</span>
        ...
 <span class="Constant">61</span>     <span class="Variable"><span class="Variable">@</span>cache_key</span> <span class="Keyword">=</span> <span class="Entity">cache_sha</span>(request.<span class="Entity">path_info</span>)
 <span class="Constant">62</span>   <span class="Keyword">end</span>
      ...
<span class="Constant">231</span>   get <span class="String"><span class="String">"</span>/<span class="String">"</span></span> <span class="Keyword">do</span>
<span class="Constant">232</span>     <span class="Keyword">begin</span>
<span class="Constant">233</span>       <span class="Keyword">raise</span> <span class="Support">Diskcached</span>::<span class="Entity">NotFound</span> <span class="Keyword">if</span> authorized?
<span class="Constant">234</span>       content <span class="Keyword">=</span> <span class="Variable"><span class="Variable">$</span>diskcache</span>.<span class="Entity">get</span>(<span class="Variable"><span class="Variable">@</span>cache_key</span>)
<span class="Constant">235</span>       logger.<span class="Entity">debug</span>(<span class="String"><span class="String">"</span>reading index from cache<span class="String">"</span></span>) <span class="Keyword">unless</span> authorized?
<span class="Constant">236</span>     <span class="Keyword">rescue</span> <span class="Support">Diskcached</span>::<span class="Entity">NotFound</span>
<span class="Constant">237</span>       logger.<span class="Entity">debug</span>(<span class="String"><span class="String">"</span>storing index to cache<span class="String">"</span></span>) <span class="Keyword">unless</span> authorized?
<span class="Constant">238</span>       content <span class="Keyword">=</span> <span class="Entity">haml</span>(<span class="Constant"><span class="Constant">:</span>index</span>, <span class="Constant"><span class="Constant">:</span>layout</span> =&gt; choose_layout)
<span class="Constant">239</span>       <span class="Variable"><span class="Variable">$</span>diskcache</span>.<span class="Entity">set</span>(<span class="Variable"><span class="Variable">@</span>cache_key</span>, content) <span class="Keyword">unless</span> authorized?
<span class="Constant">240</span>     <span class="Keyword">end</span>
<span class="Constant">241</span>     content
<span class="Constant">242</span>   <span class="Keyword">end</span>
</pre>

<h3>Test Results</h3>

<pre class="twilight">httperf --client=0/1 --server=localhost --port=9001 --uri=/ --send-buffer=4096 --recv-buffer=16384 --num-conns=100000 --num-calls=1
httperf: warning: open file limit <span class="Keyword">&gt;</span> FD_SETSIZE<span class="Keyword">;</span> limiting max. <span class="Comment"><span class="Comment">#</span> of open files to FD_SETS</span>

Maximum connect burst length: 1

Total: connections 100000 requests 100000 replies 100000 test-duration 744.646 s

Connection rate: 134.3 conn/s (7.4 ms/conn, <span class="Keyword">&lt;</span>=1 concurrent connections)
Connection <span class="SupportFunction">time</span> [ms]: min 1.9 avg 7.4 max 398.8 median 4.5 stddev 10.5
Connection <span class="SupportFunction">time</span> [ms]: connect 0.1
Connection length [replies/conn]: 1.000

Request rate: 134.3 req/s (7.4 ms/req)
Request size [B]: 62.0

Reply rate [replies/s]: min 116.6 avg 134.3 max 147.2 stddev 6.1 (148 samples)
Reply <span class="SupportFunction">time</span> [ms]: response 6.9 transfer 0.5
Reply size [B]: header 216.0 content 105088.0 footer 0.0 (total 105304.0)
Reply status: 1xx=0 2xx=100000 3xx=0 4xx=0 5xx=0

CPU <span class="SupportFunction">time</span> [s]: user 287.88 system 115.60 (user 38.7% system 15.5% total 54.2%)
Net I/O: 13818.2 KB/s (113.2*10^6 bps)

Errors: total 0 client-timo 0 socket-timo 0 connrefused 0 connreset 0
Errors: fd-unavail 0 addrunavail 0 ftab-full 0 other 0
</pre>
    
    <hr class="article_seperator">
<br><div id="disqus_thread">
      <script async src="http://rubyops.disqus.com/embed.js" type="text/javascript"></script><noscript>
        <a href="http://rubyops.disqus.com/embed.js?url=ref">View comments.</a>
      </noscript>
    </div>
  </div>
</div>
        </div>
        <div class="col-md-3 visible-md visible-lg">
          <div class="sidebar-nav">
              <ul class="share-buttons">
<li>
                  <a href="https://www.facebook.com/sharer/sharer.php?u=http://mervine.net/projects/gems/diskcached" target="_blank">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Facebook.png"></a>
                </li>
                <li>
                  <a href="https://twitter.com/intent/tweet?url=http://mervine.net/projects/gems/diskcached&amp;text=Diskchached%20-%20&amp;via=mervinej" target="_blank" title="Tweet">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Twitter.png"></a>
                </li>
                <li>
                  <a href="https://plus.google.com/share?url=http://mervine.net/projects/gems/diskcached" target="_blank" title="Share on Google+">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Google.png"></a>
                </li>
                <li>
                  <a href="http://www.reddit.com/submit?url=http://mervine.net/projects/gems/diskcached&amp;title=Diskchached" target="_blank" title="Submit to Reddit">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/Reddit.png"></a>
                </li>
                <li>
                  <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=http://mervine.net/projects/gems/diskcached&amp;title=Diskchached&amp;source=http://mervine.net/projects/gems/diskcached" target="_blank" title="Share on LinkedIn">
                    <img src="//cdn.mervine.net/bootstrap/images/simple_icons/LinkedIn.png"></a>
                </li>
              </ul>
<div class="list-group">
                <a class="list-group-item active" href="#">
                  <h4 class="list-group-item-heading">More on This</h4>
                </a>
                <a class="list-group-item" href="/projects/gems/duality">Duality</a>
              </div>
              <div class="list-group">
<a class="list-group-item active" href="http://joshua.mervine.net/">
                  <h4 class="list-group-item-heading">Joshua P. Mervine</h4>
                </a><a class="list-group-item" href="http://twitter.com/mervinej">Twitter</a>
            <a class="list-group-item" href="http://linkedin.com/in/mervinej">Linkedin</a>
            <a class="list-group-item" href="http://github.com/jmervine">Github</a>
            <a class="list-group-item" href="http://www.gittip.com/jmervine">Gittip</a>
              </div>
            </div>
        </div>
      </div>
      <center>
        <br><div id="footer">
            <div class="container">
              <p class="muted credit">
                Powered by Nesta, a
                <a href="http://nestacms.com">Ruby CMS</a>.
              </p>
            </div>
          </div>
      </center>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script><script async src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js" type="text/javascript"></script><script>
      var searchElement = 'input[name=q]';
    </script><script async src="//cdn.jsdelivr.net/jquery.webpage-vim/0.1/vim.min.js" type="text/javascript"></script><script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-32343843-1']);
        _gaq.push(['_trackPageview']);
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      </script>
</body>
</html>
